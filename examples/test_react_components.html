<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React AG-UI 卡片组件测试</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .executing-animation {
            position: relative;
            overflow: hidden;
        }
        .executing-animation::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // 简化的动画组件，替代framer-motion
        const motion = {
            div: ({ children, className, style, ...props }) => (
                React.createElement('div', {
                    className: className + (props.whileHover ? ' card' : ''),
                    style: style,
                    ...props
                }, children)
            )
        };

        const AnimatePresence = ({ children }) => children;

        // AG-UI 事件类型定义
        const AGUIEventTypes = {
            STATE_SNAPSHOT: 'STATE_SNAPSHOT',
            STATE_DELTA: 'STATE_DELTA',
            TOOL_CALL_START: 'TOOL_CALL_START',
            TOOL_CALL_END: 'TOOL_CALL_END',
            TEXT_MESSAGE_START: 'TEXT_MESSAGE_START',
            TEXT_MESSAGE_CONTENT: 'TEXT_MESSAGE_CONTENT',
            TEXT_MESSAGE_END: 'TEXT_MESSAGE_END',
            STEP_STARTED: 'STEP_STARTED',
            STEP_FINISHED: 'STEP_FINISHED'
        };

        // 动态内容生成器类
        class DynamicContentGenerator {
            generateContent(eventType, data) {
                const templates = {
                    'TEXT_MESSAGE_START': [
                        '🤖 AI正在思考中...',
                        '💭 正在组织语言...',
                        '✨ 智能回复生成中...'
                    ],
                    'TEXT_MESSAGE_CONTENT': [
                        '📝 内容正在流式输出...',
                        '⚡ 实时生成文本中...',
                        '🔄 动态更新内容...'
                    ],
                    'TOOL_CALL_START': [
                        '🔧 工具调用启动中...',
                        '⚙️ 执行智能工具...',
                        '🛠️ 处理复杂任务...'
                    ],
                    'STEP_STARTED': [
                        '📋 步骤执行开始...',
                        '🎯 任务分解处理...',
                        '⏳ 流程进行中...'
                    ],
                    'STATE_DELTA': [
                        '🔄 状态更新中...',
                        '📊 数据同步中...',
                        '⚡ 实时更新...'
                    ]
                };
                
                const options = templates[eventType] || ['🔄 处理中...'];
                const randomIndex = Math.floor(Math.random() * options.length);
                return options[randomIndex];
            }
            
            generateProgressText(progress, type) {
                if (progress < 30) {
                    return type === 'message' ? '🚀 开始生成...' : '⏳ 初始化中...';
                } else if (progress < 70) {
                    return type === 'message' ? '📝 内容生成中...' : '⚡ 处理中...';
                } else if (progress < 100) {
                    return type === 'message' ? '✨ 即将完成...' : '🔄 最后处理...';
                } else {
                    return '✅ 完成！';
                }
            }
        }

        // 卡片组件
        const CardComponent = ({ card, onAction }) => {
            const getStatusColor = (status) => {
                switch (status) {
                    case 'pending': return 'border-yellow-400 bg-yellow-50';
                    case 'executing': return 'border-blue-400 bg-blue-50';
                    case 'completed': return 'border-green-400 bg-green-50';
                    case 'error': return 'border-red-400 bg-red-50';
                    default: return 'border-gray-400 bg-gray-50';
                }
            };

            const getStatusIcon = (status) => {
                switch (status) {
                    case 'pending': return '⏳';
                    case 'executing': return '🔄';
                    case 'completed': return '✅';
                    case 'error': return '❌';
                    default: return '📋';
                }
            };

            const getTypeIcon = (type) => {
                switch (type) {
                    case 'tool_call': return '🔧';
                    case 'message': return '💬';
                    case 'step': return '📋';
                    case 'analysis': return '📊';
                    case 'state': return '🎯';
                    default: return '📄';
                }
            };

            return React.createElement(motion.div, {
                className: `relative overflow-hidden rounded-xl border-l-4 p-6 shadow-lg backdrop-blur-sm transition-all duration-300 hover:shadow-xl ${getStatusColor(card.status)} ${card.status === 'executing' ? 'executing-animation' : ''}`,
                whileHover: true
            }, [
                // 卡片头部
                React.createElement('div', {
                    key: 'header',
                    className: 'flex items-center justify-between mb-4'
                }, [
                    React.createElement('div', {
                        key: 'title-section',
                        className: 'flex items-center space-x-2'
                    }, [
                        React.createElement('span', {
                            key: 'type-icon',
                            className: 'text-2xl'
                        }, getTypeIcon(card.type)),
                        React.createElement('h3', {
                            key: 'title',
                            className: 'text-lg font-semibold text-gray-800'
                        }, card.title)
                    ]),
                    React.createElement('div', {
                        key: 'status-section',
                        className: 'flex items-center space-x-2'
                    }, [
                        React.createElement('span', {
                            key: 'status-icon',
                            className: 'text-lg'
                        }, getStatusIcon(card.status)),
                        React.createElement('span', {
                            key: 'status-badge',
                            className: `px-2 py-1 rounded-full text-xs font-medium uppercase tracking-wide ${
                                card.status === 'pending' ? 'bg-yellow-200 text-yellow-800' :
                                card.status === 'executing' ? 'bg-blue-200 text-blue-800' :
                                card.status === 'completed' ? 'bg-green-200 text-green-800' :
                                card.status === 'error' ? 'bg-red-200 text-red-800' : ''
                            }`
                        }, card.status)
                    ])
                ]),
                // 卡片内容
                React.createElement('div', {
                    key: 'content',
                    className: 'mb-4'
                }, React.createElement('p', {
                    className: 'text-gray-700 leading-relaxed whitespace-pre-wrap'
                }, card.content)),
                // 进度条
                React.createElement('div', {
                    key: 'progress',
                    className: 'mb-4'
                }, [
                    React.createElement('div', {
                        key: 'progress-header',
                        className: 'flex justify-between text-sm text-gray-600 mb-1'
                    }, [
                        React.createElement('span', { key: 'progress-label' }, '进度'),
                        React.createElement('span', { key: 'progress-value' }, `${card.progress}%`)
                    ]),
                    React.createElement('div', {
                        key: 'progress-bar-container',
                        className: 'w-full bg-gray-200 rounded-full h-2'
                    }, React.createElement('div', {
                        className: `h-2 rounded-full transition-all duration-500 ${
                            card.status === 'completed' ? 'bg-green-500' :
                            card.status === 'error' ? 'bg-red-500' :
                            card.status === 'executing' ? 'bg-blue-500' :
                            'bg-yellow-500'
                        }`,
                        style: { width: `${card.progress}%` }
                    }))
                ]),
                // 卡片元数据
                React.createElement('div', {
                    key: 'metadata',
                    className: 'flex justify-between items-center text-sm text-gray-500 border-t pt-3'
                }, [
                    React.createElement('span', { key: 'type' }, `类型: ${card.type}`),
                    React.createElement('span', { key: 'timestamp' }, card.timestamp)
                ])
            ]);
        };

        // 主要的卡片渲染器组件
        const CardRenderer = ({ wsUrl = 'ws://localhost:8000/ws', onCardAction }) => {
            const [cards, setCards] = useState(new Map());
            const [connectionStatus, setConnectionStatus] = useState('disconnected');
            const [logs, setLogs] = useState([]);
            const wsRef = useRef(null);
            const taskCounterRef = useRef(0);
            const dynamicContentGenerator = useRef(new DynamicContentGenerator());

            // 日志记录函数
            const addLog = useCallback((type, message) => {
                const timestamp = new Date().toLocaleTimeString();
                setLogs(prev => {
                    const newLogs = [...prev, { timestamp, type, message }];
                    return newLogs.slice(-100);
                });
            }, []);

            // 模拟任务流程
            const simulateTaskFlow = useCallback(() => {
                taskCounterRef.current += 1;
                const taskId = `task_${taskCounterRef.current}`;
                
                addLog('DEMO', '开始模拟任务流程');
                
                // 1. 工具调用开始
                setTimeout(() => {
                    const toolEvent = {
                        event_type: 'TOOL_CALL_START',
                        call_id: `tool_${taskId}`,
                        tool_name: 'data_analyzer',
                        arguments: { query: '分析用户行为数据' },
                        timestamp: Date.now()
                    };
                    handleToolCallStart(toolEvent);
                }, 500);
                
                // 2. 文本消息开始
                setTimeout(() => {
                    const messageEvent = {
                        event_type: 'TEXT_MESSAGE_START',
                        message_id: `msg_${taskId}`,
                        role: 'assistant',
                        timestamp: Date.now()
                    };
                    handleTextMessageStart(messageEvent);
                }, 1000);
                
                // 3. 文本消息内容更新
                setTimeout(() => {
                    const contentEvent = {
                        event_type: 'TEXT_MESSAGE_CONTENT',
                        message_id: `msg_${taskId}`,
                        content: dynamicContentGenerator.current.generateContent('TEXT_MESSAGE_START', { role: 'assistant' }),
                        timestamp: Date.now()
                    };
                    handleTextMessageContent(contentEvent);
                }, 1500);
                
                // 4. 工具调用结束
                setTimeout(() => {
                    const toolEndEvent = {
                        event_type: 'TOOL_CALL_END',
                        call_id: `tool_${taskId}`,
                        result: { status: 'success', data: '分析完成，发现3个关键趋势' },
                        timestamp: Date.now()
                    };
                    handleToolCallEnd(toolEndEvent);
                }, 2000);
                
                // 5. 文本消息结束
                setTimeout(() => {
                    const messageEndEvent = {
                        event_type: 'TEXT_MESSAGE_END',
                        message_id: `msg_${taskId}`,
                        content: '✅ 数据分析任务已完成！发现了用户行为的3个关键趋势，建议优化产品体验。',
                        timestamp: Date.now()
                    };
                    handleTextMessageEnd(messageEndEvent);
                }, 2500);
            }, [addLog]);

            // 事件处理函数
            const handleToolCallStart = useCallback((event) => {
                const dynamicContent = dynamicContentGenerator.current.generateContent('TOOL_CALL_START', event);
                const cardData = {
                    id: event.call_id,
                    title: `🔧 ${event.tool_name}`,
                    content: dynamicContent,
                    status: 'executing',
                    type: 'tool_call',
                    timestamp: new Date().toLocaleTimeString(),
                    progress: 0,
                    metadata: { arguments: event.arguments }
                };

                setCards(prev => new Map(prev).set(event.call_id, cardData));
                addLog('TOOL', `工具调用开始: ${event.tool_name}`);
            }, [addLog]);

            const handleToolCallEnd = useCallback((event) => {
                setCards(prev => {
                    const newCards = new Map(prev);
                    const card = newCards.get(event.call_id);
                    if (card) {
                        const completionText = dynamicContentGenerator.current.generateProgressText(100);
                        newCards.set(event.call_id, {
                            ...card,
                            status: 'completed',
                            content: `${completionText}\n工具执行完成\n结果: ${JSON.stringify(event.result, null, 2)}`,
                            progress: 100,
                            metadata: { ...card.metadata, result: event.result }
                        });
                    }
                    return newCards;
                });
                addLog('TOOL', `工具调用结束: ${event.call_id}`);
            }, [addLog]);

            const handleTextMessageStart = useCallback((event) => {
                const dynamicContent = dynamicContentGenerator.current.generateContent('TEXT_MESSAGE_START', event);
                const cardData = {
                    id: event.message_id,
                    title: `💬 ${event.role || 'assistant'} 消息`,
                    content: dynamicContent,
                    status: 'executing',
                    type: 'message',
                    timestamp: new Date().toLocaleTimeString(),
                    progress: 0
                };

                setCards(prev => new Map(prev).set(event.message_id, cardData));
                addLog('MESSAGE', `消息开始: ${event.message_id}`);
            }, [addLog]);

            const handleTextMessageContent = useCallback((event) => {
                setCards(prev => {
                    const newCards = new Map(prev);
                    const card = newCards.get(event.message_id);
                    if (card) {
                        newCards.set(event.message_id, {
                            ...card,
                            content: event.content || '',
                            progress: Math.min(card.progress + 20, 90)
                        });
                    }
                    return newCards;
                });
            }, []);

            const handleTextMessageEnd = useCallback((event) => {
                setCards(prev => {
                    const newCards = new Map(prev);
                    const card = newCards.get(event.message_id);
                    if (card) {
                        const completionText = dynamicContentGenerator.current.generateProgressText(100);
                        newCards.set(event.message_id, {
                            ...card,
                            status: 'completed',
                            content: `${completionText}\n${event.content || card.content}`,
                            progress: 100
                        });
                    }
                    return newCards;
                });
                addLog('MESSAGE', `消息结束: ${event.message_id}`);
            }, [addLog]);

            // 清空卡片
            const clearCards = useCallback(() => {
                setCards(new Map());
                addLog('UI', '已清空所有卡片');
            }, [addLog]);

            return React.createElement('div', {
                className: 'container mx-auto p-6 bg-white/10 backdrop-blur-md rounded-2xl shadow-2xl'
            }, [
                // 标题
                React.createElement('div', {
                    key: 'header',
                    className: 'text-center mb-8'
                }, [
                    React.createElement('h1', {
                        key: 'title',
                        className: 'text-4xl font-bold text-white mb-2'
                    }, '🚀 React AG-UI 卡片组件'),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: 'text-white/80 text-lg'
                    }, '动态事件处理与智能UI渲染演示')
                ]),
                
                // 控制面板
                React.createElement('div', {
                    key: 'controls',
                    className: 'bg-white/20 backdrop-blur-sm rounded-xl p-6 mb-8'
                }, [
                    React.createElement('div', {
                        key: 'control-header',
                        className: 'flex items-center justify-between mb-4'
                    }, [
                        React.createElement('h2', {
                            key: 'control-title',
                            className: 'text-xl font-semibold text-white'
                        }, '🎮 控制面板'),
                        React.createElement('div', {
                            key: 'connection-status',
                            className: 'flex items-center space-x-2'
                        }, [
                            React.createElement('div', {
                                key: 'status-indicator',
                                className: `w-3 h-3 rounded-full ${
                                    connectionStatus === 'connected' ? 'bg-green-400' :
                                    connectionStatus === 'connecting' ? 'bg-yellow-400' :
                                    'bg-red-400'
                                }`
                            }),
                            React.createElement('span', {
                                key: 'status-text',
                                className: 'text-white text-sm'
                            }, connectionStatus === 'connected' ? '已连接' :
                               connectionStatus === 'connecting' ? '连接中' : '未连接')
                        ])
                    ]),
                    React.createElement('div', {
                        key: 'buttons',
                        className: 'flex flex-wrap gap-3'
                    }, [
                        React.createElement('button', {
                            key: 'simulate-btn',
                            onClick: simulateTaskFlow,
                            className: 'px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors font-medium'
                        }, '🎭 模拟任务流程'),
                        React.createElement('button', {
                            key: 'clear-btn',
                            onClick: clearCards,
                            className: 'px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors font-medium'
                        }, '🗑️ 清空卡片')
                    ])
                ]),
                
                // 卡片网格
                React.createElement('div', {
                    key: 'cards-grid',
                    className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8'
                }, React.createElement(AnimatePresence, {}, 
                    Array.from(cards.values()).map((card) => 
                        React.createElement(CardComponent, {
                            key: card.id,
                            card: card,
                            onAction: onCardAction
                        })
                    )
                )),
                
                // 日志面板
                React.createElement('div', {
                    key: 'logs',
                    className: 'bg-black/20 backdrop-blur-sm rounded-xl p-6'
                }, [
                    React.createElement('h3', {
                        key: 'logs-title',
                        className: 'text-lg font-semibold text-white mb-4'
                    }, '📋 事件日志'),
                    React.createElement('div', {
                        key: 'logs-container',
                        className: 'bg-black/40 rounded-lg p-4 h-48 overflow-y-auto font-mono text-sm'
                    }, logs.slice(-20).map((log, index) => 
                        React.createElement('div', {
                            key: index,
                            className: `mb-1 ${
                                log.type === 'ERROR' ? 'text-red-300' :
                                log.type === 'SUCCESS' ? 'text-green-300' :
                                log.type === 'WARNING' ? 'text-yellow-300' :
                                'text-gray-300'
                            }`
                        }, `[${log.timestamp}] ${log.type}: ${log.message}`)
                    ))
                ])
            ]);
        };

        // 使用示例组件
        const CardRendererExample = () => {
            const handleCardAction = (action, cardId) => {
                console.log(`执行操作: ${action} on card: ${cardId}`);
            };

            return React.createElement(CardRenderer, {
                wsUrl: 'ws://localhost:8000/ws',
                onCardAction: handleCardAction
            });
        };

        // 渲染应用
        ReactDOM.render(
            React.createElement(CardRendererExample),
            document.getElementById('root')
        );
    </script>
</body>
</html>